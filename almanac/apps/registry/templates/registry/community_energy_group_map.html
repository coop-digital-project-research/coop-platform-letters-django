{% extends "base.html" %}

{% load static %}

{% block head_inner %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"
   integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="
   crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"
   integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=="
   crossorigin=""></script>

{% endblock %}

{% block body_class %}almanac-map{% endblock %}

{% block body_inner %}

<header class="almanac">
  <h1>Endless Energy Almanac</h1>
  <section id="about-almanac">
    <p>
      An open source, collaborative map of every active, generating renewable energy co-operative.
    </p>
  </section>
</header>

<div id="mapid"></div>

<section id="group-details">
  <h1 id="group-name">groupName</h1>
  <ul>
    <li id="group-website"><a target="_blank">groupWebsite</a></li>
    <li id="group-phone"><a>groupPhone</a></li>
    <li id="group-email"><a>groupEmail</a></li>
  </ul>
</section>

<script>

  var map = L.map('mapid').setView([51.505, -0.09], 13);

  function fetchJSONFile(path, callback) {
    var httpRequest = new XMLHttpRequest();
    httpRequest.onreadystatechange = function() {
        if (httpRequest.readyState === 4) {
            if (httpRequest.status === 200) {
                var data = JSON.parse(httpRequest.responseText);
                if (callback) callback(data);
            }
        }
    };
    httpRequest.open('GET', path);
    httpRequest.send();
  }

  var defaultIcon = L.icon({
    iconUrl: '{% static "/images/marker-icon.png" %}',
    shadowUrl: '{% static "/images/marker-shadow.png" %}'
  })

  var highlightIcon = L.icon({
    iconUrl: '{% static "/images/marker-icon-highlighted.png" %}',
    shadowUrl: '{% static "/images/marker-shadow.png" %}'
  })

  var groups = new L.FeatureGroup();

  var groupDetails = document.getElementById('group-details');

  var deselectAllMarkers = function() {
    groupDetails.classList.remove("show-group-detail");
    groups.eachLayer(function(layer) {
      layer.setIcon(defaultIcon);
    });
  }

  map.on('click', deselectAllMarkers);

  fetchJSONFile('/apiv1/community-energy-groups/', function(data){
    for (var i = 0, l = data.length; i < l; i++) {
      var obj = data[i];
      if(obj["latitude"] && obj["longitude"]) {
        L.marker([obj["latitude"], obj["longitude"]], {
          name: obj["name"],
          website: obj["website"],
          phone: obj["contact_telephone"],
          email: obj["contact_email"],
          icon: defaultIcon,
        }).on('click', function(e) {
          deselectAllMarkers();
          this.setIcon(highlightIcon);
          groupDetails.classList.add("show-group-detail");
          document.getElementById("group-name").innerHTML = this.options.name;
          document.getElementById("group-website").firstChild.innerHTML = this.options.website;
          document.getElementById("group-website").firstChild.href = this.options.website;
          document.getElementById("group-phone").firstChild.innerHTML = this.options.phone;
          document.getElementById("group-phone").firstChild.href = "tel:" + this.options.phone;
          document.getElementById("group-email").firstChild.innerHTML = this.options.email;
          document.getElementById("group-email").firstChild.href = "mailto:" + this.options.email;
        }).addTo(groups);
      }
    };

    groups.addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
      maxZoom: 18
    }).addTo(map);

    map.fitBounds(groups.getBounds());
  });



</script>


{% endblock %}
